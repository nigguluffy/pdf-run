name: CI for QuizBots with Enhanced Math Support

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  mail: "github-actions@github.com"
  username: "github-actions[bot]"
  ACTIONS_RUNNER_DEBUG: true
  ACTIONS_STEP_DEBUG: true
  
jobs:
  quizbot1:
    name: Remedics-Bot-Math-Fixed
    runs-on: ubuntu-latest
    steps:
      - name: Clone The Remedics Bot Repo
        run: git clone https://${{ secrets.GH_TOKEN }}@github.com/${{ secrets.REPOSLUG }} remedics

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
        timeout-minutes: 5
        continue-on-error: false

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libreoffice-writer \
            ure \
            libreoffice-java-common \
            poppler-utils \
            libpango-1.0-0 \
            libpangoft2-1.0-0 \
            poppler-data \
            libpoppler-dev \
            wget \
            fontconfig \
            fontconfig-config \
            libfontconfig1 \
            libfontconfig1-dev \
            unzip \
            curl
          
          # Clean up to save space
          sudo apt-get purge -y libreoffice-help-* libreoffice-l10n-* libreoffice-dict-* || true
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install Math Fonts and Microsoft Core Fonts
        run: |
          # Accept Microsoft EULA automatically
          echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | sudo debconf-set-selections
          
          # Install Microsoft core fonts (includes Times New Roman, Arial, etc.)
          sudo apt-get update
          sudo apt-get install -y ttf-mscorefonts-installer
          
          # Install additional math-specific font packages
          sudo apt-get install -y --no-install-recommends \
            fonts-dejavu \
            fonts-liberation \
            fonts-liberation2 \
            fonts-lmodern \
            fonts-stix \
            fonts-texgyre \
            fonts-noto-core \
            fonts-noto-ui-core \
            xfonts-mathml \
            ttf-lyx
          
          # Create custom font directories
          sudo mkdir -p /usr/share/fonts/truetype/custom
          sudo mkdir -p /usr/share/fonts/opentype/custom
          
          # Copy project fonts
          sudo cp -r remedics/truetype/*/*.ttf /usr/share/fonts/truetype/custom/
          
          # Set proper permissions
          sudo chmod 644 /usr/share/fonts/truetype/custom/* 2>/dev/null || true
          
          # Configure fontconfig for math compatibility
          sudo tee /etc/fonts/local.conf << 'EOF'
          <?xml version="1.0"?>
          <!DOCTYPE fontconfig SYSTEM "fonts.dtd">
          <fontconfig>
              <alias>
                  <family>Cambria Math</family>
                  <prefer>
                      <family>STIX Two Math</family>
                      <family>Latin Modern Math</family>
                      <family>DejaVu Sans</family>
                  </prefer>
              </alias>
              <alias>
                  <family>Times New Roman</family>
                  <prefer>
                      <family>Liberation Serif</family>
                      <family>DejaVu Serif</family>
                  </prefer>
              </alias>
              <alias>
                  <family>Arial</family>
                  <prefer>
                      <family>Liberation Sans</family>
                      <family>DejaVu Sans</family>
                  </prefer>
              </alias>
          </fontconfig>
          EOF
          
          # Refresh font cache
          sudo fc-cache -fv
          sudo fc-cache -fs
          
          # Verify font installation
          echo "=== Available Math Fonts ==="
          fc-list | grep -i -E "stix|liberation|dejavu|times|arial|cambria" | head -5 || echo "‚ö†Ô∏è Some fonts not detected"

      - name: Create MML2OMML Stylesheet for Linux
        run: |
          # Create directory for MML2OMML stylesheet
          sudo mkdir -p /usr/share/mathml2omml
          
          # Create the MML2OMML.XSL stylesheet (equivalent to Windows Office version)
          sudo tee /usr/share/mathml2omml/MML2OMML.XSL << 'EOF'
          <?xml version='1.0' encoding="UTF-8"?>
          <xsl:stylesheet version="1.0" 
                          xmlns:xsl="http://www.w3.org/1999/XSL/Transform" 
                          xmlns:mml="http://www.w3.org/1998/Math/MathML" 
                          xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math">
          
          <xsl:output method="xml" indent="no" encoding="UTF-8"/>
          
          <!-- Root math element -->
          <xsl:template match="mml:math">
              <m:oMath>
                  <xsl:apply-templates select="*"/>
              </m:oMath>
          </xsl:template>
          
          <!-- Fraction -->
          <xsl:template match="mml:mfrac">
              <m:f>
                  <m:fPr/>
                  <m:num>
                      <m:r>
                          <xsl:apply-templates select="*[1]"/>
                      </m:r>
                  </m:num>
                  <m:den>
                      <m:r>
                          <xsl:apply-templates select="*[2]"/>
                      </m:r>
                  </m:den>
              </m:f>
          </xsl:template>
          
          <!-- Square root -->
          <xsl:template match="mml:msqrt">
              <m:rad>
                  <m:radPr/>
                  <m:deg/>
                  <m:e>
                      <m:r>
                          <xsl:apply-templates select="*"/>
                      </m:r>
                  </m:e>
              </m:rad>
          </xsl:template>
          
          <!-- Superscript -->
          <xsl:template match="mml:msup">
              <m:sSup>
                  <m:sSupPr/>
                  <m:e>
                      <m:r>
                          <xsl:apply-templates select="*[1]"/>
                      </m:r>
                  </m:e>
                  <m:sup>
                      <m:r>
                          <xsl:apply-templates select="*[2]"/>
                      </m:r>
                  </m:sup>
              </m:sSup>
          </xsl:template>
          
          <!-- Subscript -->
          <xsl:template match="mml:msub">
              <m:sSub>
                  <m:sSubPr/>
                  <m:e>
                      <m:r>
                          <xsl:apply-templates select="*[1]"/>
                      </m:r>
                  </m:e>
                  <m:sub>
                      <m:r>
                          <xsl:apply-templates select="*[2]"/>
                      </m:r>
                  </m:sub>
              </m:sSub>
          </xsl:template>
          
          <!-- Subscript and Superscript -->
          <xsl:template match="mml:msubsup">
              <m:sSubSup>
                  <m:sSubSupPr/>
                  <m:e>
                      <m:r>
                          <xsl:apply-templates select="*[1]"/>
                      </m:r>
                  </m:e>
                  <m:sub>
                      <m:r>
                          <xsl:apply-templates select="*[2]"/>
                      </m:r>
                  </m:sub>
                  <m:sup>
                      <m:r>
                          <xsl:apply-templates select="*[3]"/>
                      </m:r>
                  </m:sup>
              </m:sSubSup>
          </xsl:template>
          
          <!-- Multi-scripts (for isotopes) -->
          <xsl:template match="mml:mmultiscripts">
              <m:sSubSup>
                  <m:sSubSupPr/>
                  <m:e>
                      <m:r>
                          <xsl:apply-templates select="*[1]"/>
                      </m:r>
                  </m:e>
                  <m:sub>
                      <m:r>
                          <xsl:apply-templates select="*[2]"/>
                      </m:r>
                  </m:sub>
                  <m:sup>
                      <m:r>
                          <xsl:apply-templates select="*[4]"/>
                      </m:r>
                  </m:sup>
              </m:sSubSup>
          </xsl:template>
          
          <!-- Identifier -->
          <xsl:template match="mml:mi">
              <m:t>
                  <xsl:value-of select="."/>
              </m:t>
          </xsl:template>
          
          <!-- Number -->
          <xsl:template match="mml:mn">
              <m:t>
                  <xsl:value-of select="."/>
              </m:t>
          </xsl:template>
          
          <!-- Operator -->
          <xsl:template match="mml:mo">
              <m:t>
                  <xsl:value-of select="."/>
              </m:t>
          </xsl:template>
          
          <!-- Text -->
          <xsl:template match="mml:mtext">
              <m:t>
                  <xsl:value-of select="."/>
              </m:t>
          </xsl:template>
          
          <!-- Row -->
          <xsl:template match="mml:mrow">
              <xsl:apply-templates select="*"/>
          </xsl:template>
          
          <!-- Handle none elements (placeholders) -->
          <xsl:template match="mml:none"/>
          
          </xsl:stylesheet>
          EOF
          
          # Set environment variable for Python code
          echo "MML2OMML_STYLESHEET_PATH=/usr/share/mathml2omml/MML2OMML.XSL" >> $GITHUB_ENV
          
          # Verify stylesheet creation
          if [ -f /usr/share/mathml2omml/MML2OMML.XSL ]; then
              echo "‚úÖ MML2OMML stylesheet created successfully"
              ls -la /usr/share/mathml2omml/MML2OMML.XSL
          else
              echo "‚ùå Failed to create MML2OMML stylesheet"
          fi

      - name: Install Enhanced Python Dependencies
        run: |
          # Upgrade pip
          pip install --upgrade pip
          
          # Install XML processing libraries
          pip install lxml html5lib requests
          
          # Install mathml2omml with multiple attempts
          pip install mathml2omml || echo "Primary mathml2omml failed"
          pip install git+https://github.com/AlloteSoftware/mathml2omml_as.git || echo "Alternative mathml2omml_as failed"
          
          # Verify installations
          python3 -c "
          print('=== Python Math Library Status ===')
          try:
              import mathml2omml_as
              print('‚úÖ mathml2omml_as available')
          except ImportError:
              try:
                  import mathml2omml  
                  print('‚úÖ mathml2omml available')
              except ImportError:
                  print('‚ö†Ô∏è No mathml2omml - using text fallback')
          
          try:
              from lxml import etree
              print('‚úÖ lxml available')
          except ImportError:
              print('‚ùå lxml missing')
          
          import os
          stylesheet = os.environ.get('MML2OMML_STYLESHEET_PATH')
          if stylesheet and os.path.exists(stylesheet):
              print(f'‚úÖ MML2OMML stylesheet: {stylesheet}')
          else:
              print('‚ö†Ô∏è MML2OMML stylesheet not found')
          "

      - name: Test Math Processing Environment
        run: |
          cd remedics
          python3 -c "
          import platform
          print(f'üñ•Ô∏è Platform: {platform.system()} {platform.release()}')
          
          # Test simple MathML conversion
          test_mathml = '<math xmlns=\"http://www.w3.org/1998/Math/MathML\"><mfrac><mn>1</mn><mn>2</mn></mfrac></math>'
          
          # Test stylesheet method
          import os
          from lxml import etree
          stylesheet_path = os.environ.get('MML2OMML_STYLESHEET_PATH')
          if stylesheet_path and os.path.exists(stylesheet_path):
              try:
                  tree = etree.fromstring(test_mathml.encode('utf-8'))
                  xslt = etree.parse(stylesheet_path)
                  transform = etree.XSLT(xslt)
                  result = transform(tree)
                  if result and result.getroot() is not None:
                      print('‚úÖ MathML to OMML conversion test passed')
                  else:
                      print('‚ö†Ô∏è MathML conversion returned empty result')
              except Exception as e:
                  print(f'‚ö†Ô∏è MathML conversion test failed: {e}')
          
          print('üöÄ Environment setup complete - starting bot...')
          "

      - name: Install Project Dependencies and Run Bot
        run: |
          cd remedics
          pip install -r requirements.txt
          python main.py
        timeout-minutes: 340
        continue-on-error: true

  looper:
    name: Run QuizBot Loop  
    needs: quizbot1
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Git Configs & Secrets
        run: |
          git config --global user.email "${{ env.mail }}"
          git config --global user.name "${{ env.username }}"
          git config --global pull.rebase false
          git config --global credential.helper store
          echo "https://${{ env.username }}:${{ secrets.GH_TOKEN }}@github.com" > ~/.git-credentials

      - name: Notify Telegram (Enhanced Math Support)
        run: |
          TZ="Asia/Dhaka"
          CURRENT_TIME=$(TZ=$TZ date +"%Y-%m-%d %H:%M:%S")
          END_TIME=$(TZ=$TZ date -d "+345 minutes" +"%Y-%m-%d %H:%M:%S")
          
          MESSAGE="‚úÖ Enhanced workflow complete with cross-platform math support!
          
          üîß Improvements:
          ‚Ä¢ Microsoft Core Fonts installed
          ‚Ä¢ MML2OMML stylesheet created for Linux  
          ‚Ä¢ Enhanced font compatibility
          ‚Ä¢ Cross-platform math equation rendering
          
          üïí Current time (BD): $CURRENT_TIME
          ‚è≥ Next restart: $END_TIME
          üìä Math equations should now render properly in both DOCX and PDF files!"
          
          curl -X POST \
            "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d parse_mode=HTML \
            -d text="$MESSAGE"

      - name: Create Empty Commit for Loop
        run: |
          git clone https://${{ secrets.GH_TOKEN }}@github.com/${GITHUB_REPOSITORY} temp
          cd temp
          git commit --allow-empty -m "[LOOP] Enhanced math support workflow restart"
          git push
